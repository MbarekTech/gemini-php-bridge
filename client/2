# Specify the URL to your PHP script (absolute path)
$phpApiUrl = "http://aska.website/a/index.php"  # Full URL that works regardless of where the script is run

# Get the current directory where the script is running from
$currentDir = Get-Location


# Search for files in current directory
$textFiles = Get-ChildItem -Path $currentDir -Filter "*.txt"

# Initialize variables for file paths
$textFilePath = ""

# Check number of text files found
if ($textFiles.Count -gt 1) {
    Write-Host "Error: Multiple text files found, please use only one txt file"
    return;
} elseif($textFiles.Count -eq 1) {
    $textFilePath = $textFiles[0].FullName
}


# Read the text file content
if ($textFilePath) {
    try {
        $fileContent = Get-Content -Path $textFilePath -Encoding UTF8
        $fileContentBytes = [System.Text.Encoding]::UTF8.GetBytes($fileContent)
    }
    catch {
        Write-Host "Error reading text file: $($_.Exception.Message)"
        return
    }
} else {
    Write-Host "No text file found, skipping content sending."
    return
}


# Make the HTTP POST request using Invoke-WebRequest
try {
    $response = Invoke-WebRequest -Uri $phpApiUrl -Method Post -Body $fileContentBytes -ContentType "text/plain; charset=utf-8"
    
    # Output response text
     $responseContent = $response.Content
     # Attempt to convert the response to JSON
    try {
        $responseJson = $responseContent | ConvertFrom-Json
        if ($responseJson.candidates -and $responseJson.candidates[0].content -and $responseJson.candidates[0].content.parts) {
            $responseText = $responseJson.candidates[0].content.parts[0].text
             Write-Host $responseText
        } else {
              Write-Host "Error: Could not extract text from response"
             
        }
    } catch {
        # If it can't be converted to JSON, it may be an error object, just echo to terminal
        Write-Host "Error: JSON Parsing Error"
        Write-Host "Response: $($responseContent)"
    }
    
} catch {
    Write-Host "Error during API request:"
    Write-Host  $($_.Exception.Message)
    if ($_.Exception.Response.Content) {
         Write-Host  "Response Content: $($_.Exception.Response.Content)"
    }
   
}