# Specify the URL to your PHP script (absolute path)
$phpApiUrl = "http://aska.website/a/11.php"

# Get the current directory where the script is running from
$currentDir = Get-Location

# Search for image files in the current directory
$imageFiles = Get-ChildItem -Path $currentDir -Include *.jpg, *.jpeg, *.png, *.gif, *.bmp -Recurse

# Initialize variables for file paths
$imageFilePath = ""

# Check number of image files found
if ($imageFiles.Count -gt 1) {
    Write-Host "Error: Multiple image files found, please use only one file at a time"
    return;
} elseif($imageFiles.Count -eq 1) {
    $imageFilePath = $imageFiles[0].FullName
}
else {
    Write-Host "No image files found in directory, exiting"
    return;
}

# Read the image file content and convert to base64
if ($imageFilePath) {
    try {
        $imageBytes = [System.IO.File]::ReadAllBytes($imageFilePath)
        $imageBase64 = [System.Convert]::ToBase64String($imageBytes)
    }
    catch {
        Write-Host "Error reading image file: $($_.Exception.Message)"
        return
    }
} else {
    Write-Host "No image file found, skipping content sending."
    return
}

# Make the HTTP POST request using Invoke-WebRequest
# Make the HTTP POST request using Invoke-WebRequest
# Make the HTTP POST request using Invoke-WebRequest
try {
    $boundary = [System.Guid]::NewGuid().ToString()
    $headers = @{
        "Content-Type" = "multipart/form-data; boundary=$boundary"
    }

    # Construct the multipart form data body
    $bodyLines = @(
        "--$boundary",
        "Content-Disposition: form-data; name=`"imageFile`"; filename=`"$(Split-Path $imageFilePath -Leaf)`"",
        "Content-Type: image/$([System.IO.Path]::GetExtension($imageFilePath).Substring(1))",
        "Content-Transfer-Encoding: base64",
        "",
        $imageBase64,
        "--$boundary--"
    )
    $body = $bodyLines -join "`r`n"

    # Send the request
    $response = Invoke-WebRequest -Uri $phpApiUrl -Method Post -Headers $headers -Body $body
    
    # Output response text
    $responseContent = $response.Content

    # Parse the JSON response
    try {
        $responseJson = $responseContent | ConvertFrom-Json

        # Extract the text content from the JSON response
        if ($responseJson.candidates -and $responseJson.candidates[0].content -and $responseJson.candidates[0].content.parts) {
            $responseText = $responseJson.candidates[0].content.parts[0].text

            # Parse the text to extract file names and content
            $files = @{}
            $currentFileName = ""
            $currentFileContent = @()

            # Split the response into lines
            $lines = $responseText -split "`n"

            foreach ($line in $lines) {
                if ($line -match "FILE_START:(.*)") {
                    # Start of a new file
                    $currentFileName =  $matches[1].Trim()
                    $currentFileContent = @()
                } elseif ($line -match "FILE_END:(.*)") {
                    # End of the current file
                    if ($currentFileName -ne "") {
                        $files[$currentFileName] = ($currentFileContent -join "`n").Trim()
                        $currentFileName = ""
                        $currentFileContent = @()
                    }
                } else {
                    # Append to the current file content
                    if ($currentFileName -ne "") {
                        $currentFileContent += $line
                    }
                }
            }

            # Create files based on the parsed content
            foreach ($fileName in $files.Keys) {
                $filePath = Join-Path -Path $currentDir -ChildPath $fileName

                # Ensure the directory exists
                $directory = Split-Path -Path $filePath -Parent
                if (-not (Test-Path -Path $directory)) {
                    New-Item -ItemType Directory -Path $directory | Out-Null
                }

                # Create the file
                Set-Content -Path $filePath -Value $files[$fileName] -Encoding UTF8
                Write-Host "File created: $filePath"
            }
        } else {
            Write-Host "Error: Could not extract text from response"
        }
    } catch {
        Write-Host "Error parsing JSON response: $($_.Exception.Message)"
    }
} catch {
    Write-Host "Error during API request:"
    Write-Host  $($_.Exception.Message)
    if ($_.Exception.Response) {
        Write-Host  "Response Content: $($_.Exception.Response.Content)"
    }
}